---
import { type DetailsMovie } from "@/types/apiDetailsMovies";
import { type ReleaseDate, type Result } from "@/types/apiReleaseDate";
import { type Credits, type Cast } from "@/types/apiCreditsMovie";
import { type SimilarMovies } from "@/types/apiSimilarMovies";
import { type MoviesReviews } from "@/types/apiMovieReviews";
import { type VideoMovies, type VideoResult } from "@/types/VideoMovies";
import { getDetailsMovie } from "@/services/getDetailsMovie";
import Layout from "@/layouts/Layout.astro";
import DetailsMovies from "@/components/DetailsMovies.astro";
import TopCast from "@/components/TopCast.astro";
import SimilarMoviesContainer from "@/components/SimilarMoviesContainer.astro";
import ReviewsContainer from "@/components/ReviewsContainer.astro";

export const prerender = false;

const { id: movieId } = Astro.params;

let movieDetails;
let releaseDate;
let credits;
let similarMovies;
let reviews;
let movieVideos;

if (movieId) {
  movieDetails = (await getDetailsMovie(movieId)) as DetailsMovie;
  releaseDate = (await getDetailsMovie(
    movieId,
    "/release_dates"
  )) as ReleaseDate;
  credits = (await getDetailsMovie(movieId, "/credits")) as Credits;
  similarMovies = (await getDetailsMovie(movieId, "/similar")) as SimilarMovies;
  reviews = (await getDetailsMovie(movieId, "/reviews")) as MoviesReviews;
  movieVideos = (await getDetailsMovie(movieId, "/videos")) as VideoMovies;
}

function getRuntime(runtime: number) {
  const hours = Math.floor(runtime / 60);
  const minutes = Math.floor(runtime % 60);
  return `${hours}h ${minutes}m`;
}

function getReleaseDate(releaseDate: ReleaseDate) {
  return releaseDate.results.map((result: Result) => {
    if (result.iso_3166_1 === "EE") {
      let date = new Date(result.release_dates[0].release_date);
      let day = date.getUTCDate();
      let month = date.getUTCMonth() + 1;
      let year = date.getUTCFullYear();
      return `${day}/${month}/${year}`;
    }
  });
}

function getTopBilledCast(credits: Credits) {
  let cast = credits.cast.filter(
    (cast: Cast) => cast && cast.order !== undefined && cast.order < 6
  );

  if (cast.length > 0) {
    return cast.sort((a, b) => b.popularity - a.popularity);
  } else {
    return [];
  }
}

function getMostPopularDirector(credits: Credits) {
  let directors = credits.crew.filter(
    (crew: Cast) => crew && crew.department === "Directing"
  );

  if (directors.length > 0) {
    return directors.sort((a, b) => b.popularity - a.popularity);
  } else {
    return [];
  }
}

function getSimilarMovies(similarMovies: SimilarMovies) {
  let movies = similarMovies.results;

  if (movies.length > 0) {
    return movies.sort((a, b) => b.popularity - a.popularity);
  } else {
    return [];
  }
}

function getReviews(reviews: MoviesReviews) {
  let movies = reviews.results;

  if (movies.length > 0) {
    return movies.filter((movie) => movie.author_details?.avatar_path);
  } else {
    return [];
  }
}

function getTrailer(movieVideos: VideoMovies) {
  if (!movieVideos.results.length) return "";

  let trailer = movieVideos.results.find(
    (result: VideoResult) =>
      result.type === "Trailer" && result.official && result.site === "YouTube"
  );

  if (!trailer) {
    trailer = movieVideos.results.find(
      (result: VideoResult) =>
        result.type === "Trailer" && result.site === "YouTube"
    );
  }

  if (!trailer && movieVideos.results.length > 0) {
    trailer = movieVideos.results[0];
  }

  return trailer ? trailer.key : "";
}
---

<Layout title=`${movieDetails?.original_title} - Reel Library`>
  <div class="flex flex-col gap-5 md:gap-10">
    <DetailsMovies
      key=`${movieVideos ? getTrailer(movieVideos) : ""}`
      img=`${movieDetails?.poster_path}`
      title={`${movieDetails?.original_title}`}
      average={`${movieDetails?.vote_average.toFixed(1)}`}
      alt={`${movieDetails?.original_title}`}
      overview={`${movieDetails?.overview}`}
      runtime={movieDetails?.runtime ? getRuntime(movieDetails.runtime) : ""}
      realeaseDate={releaseDate ? getReleaseDate(releaseDate) : undefined}
      genres={movieDetails?.genres || []}
      credits={credits ? getMostPopularDirector(credits) : []}
    />
    <TopCast cast={credits ? getTopBilledCast(credits) : []} />
    <ReviewsContainer reviews={reviews ? getReviews(reviews) : []} />
    <SimilarMoviesContainer
      similarMovies={similarMovies ? getSimilarMovies(similarMovies) : []}
    />
  </div>
</Layout>
